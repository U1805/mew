import { type SVGProps } from 'react';
import { Icon } from '@iconify/react';
import clsx from 'clsx';
import { useUIStore, useModalStore, useUnreadStore } from '../../../shared/stores';
import { useServersWithChannels } from '../hooks/useServersWithChannels';

const MewLogo = (props: SVGProps<SVGSVGElement>) => (
  <svg
    viewBox="0 0 1136 944"
    fill="currentColor"
    xmlns="http://www.w3.org/2000/svg"
    {...props}
  >
    <path d=" M 184.50 107.57 C 185.90 104.27 186.57 100.48 189.02 97.75 C 193.01 97.72 196.95 98.52 200.88 99.14 C 229.34 103.48 257.18 111.24 284.38 120.55 C 324.71 134.70 363.03 154.19 399.16 176.95 C 400.86 178.14 402.91 178.84 404.96 178.12 C 415.79 175.59 426.55 172.73 437.42 170.40 C 438.48 170.17 439.55 170.08 440.63 170.14 C 450.02 185.94 457.47 202.84 466.34 218.92 C 472.27 218.81 478.07 217.26 483.98 216.85 C 541.19 208.35 599.68 208.70 656.88 217.18 C 661.17 217.68 665.39 218.82 669.72 218.92 C 672.69 214.59 674.55 209.63 677.02 205.02 C 681.36 195.90 686.39 187.15 691.17 178.26 C 692.75 175.38 694.05 172.31 696.09 169.70 C 713.85 172.87 731.33 177.65 749.06 181.07 C 750.77 181.58 752.30 180.56 753.70 179.71 C 786.41 157.15 820.91 136.89 857.74 121.79 C 886.59 109.98 916.86 100.81 947.96 97.71 C 949.18 98.72 949.67 100.30 950.33 101.70 C 964.19 135.71 970.81 172.41 972.20 209.02 C 973.08 232.91 971.25 256.84 967.40 280.42 C 964.14 302.89 958.98 325.10 951.69 346.61 C 949.66 351.90 953.80 356.66 955.58 361.38 C 961.75 376.02 967.58 390.81 973.32 405.63 C 990.85 454.29 1004.00 504.63 1011.16 555.89 C 1014.40 581.47 1016.62 607.17 1017.61 632.93 C 1017.79 658.66 1018.05 684.41 1015.85 710.06 C 1015.17 718.37 1014.47 726.69 1013.70 735.00 C 1013.75 737.08 1012.30 738.59 1010.75 739.75 C 995.29 751.62 978.83 762.09 962.19 772.21 C 932.19 790.90 900.65 807.05 868.27 821.22 C 852.30 827.85 836.38 834.68 819.89 839.94 C 808.75 843.66 797.76 848.19 786.23 850.51 C 779.54 842.16 773.78 833.08 767.81 824.20 C 760.71 814.02 754.74 803.13 748.62 792.35 C 745.41 786.05 741.24 780.11 739.20 773.30 C 765.23 763.07 791.68 752.84 814.78 736.76 C 811.80 733.17 807.54 730.97 804.12 727.85 C 801.34 725.78 799.16 722.75 795.96 721.33 C 792.87 722.15 790.15 723.91 787.28 725.27 C 774.20 731.58 760.92 737.55 747.12 742.15 C 715.06 753.65 681.67 761.14 648.02 766.13 C 621.87 769.93 595.44 772.02 569.00 771.69 C 530.07 772.25 491.20 767.66 453.09 759.89 C 415.76 752.05 378.94 740.55 345.02 722.94 C 343.50 722.30 341.98 721.38 340.29 721.43 C 337.48 723.15 335.20 725.59 332.62 727.63 C 329.00 730.71 324.98 733.27 321.35 736.33 C 332.97 745.10 346.29 751.39 359.44 757.55 C 371.82 763.61 384.88 768.09 397.63 773.27 C 384.78 799.78 368.91 824.82 351.54 848.60 C 351.01 849.28 350.42 849.91 349.79 850.51 C 347.50 850.27 345.31 849.52 343.12 848.86 C 320.57 841.62 298.15 833.90 276.34 824.65 C 260.00 818.08 244.19 810.32 228.38 802.60 C 211.94 793.88 195.33 785.39 179.57 775.45 C 160.84 764.12 142.27 752.44 124.86 739.14 C 122.35 737.66 122.48 734.55 122.19 732.04 C 120.62 712.38 119.01 692.74 118.36 673.03 C 118.48 656.01 117.77 638.96 119.17 621.98 C 120.90 576.53 127.64 531.33 138.11 487.09 C 146.03 453.46 157.01 420.63 169.49 388.44 C 173.38 379.34 177.26 370.24 181.16 361.15 C 182.59 357.67 184.70 354.43 185.52 350.73 C 185.48 347.31 183.99 344.12 183.12 340.87 C 174.61 312.23 169.01 282.76 165.94 253.04 C 161.69 204.01 166.83 153.70 184.50 107.57 M 209.55 156.55 C 206.95 164.37 206.06 172.64 204.61 180.73 C 200.79 203.94 200.92 227.67 204.06 250.95 C 207.73 280.12 215.85 308.65 227.24 335.73 C 229.76 341.65 231.78 347.82 235.01 353.41 C 243.51 344.42 250.38 333.96 259.39 325.41 C 289.49 292.93 326.78 267.79 366.47 248.50 C 369.62 247.08 372.89 245.85 375.82 243.98 C 368.60 236.22 360.29 229.58 352.09 222.89 C 339.37 212.77 326.27 203.05 312.33 194.65 C 284.81 177.65 254.73 164.07 222.74 158.28 C 218.36 157.61 214.01 156.31 209.55 156.55 M 925.57 156.50 C 905.63 159.21 886.14 164.83 867.56 172.52 C 833.60 186.93 802.52 207.60 774.70 231.71 C 770.23 235.64 765.49 239.37 761.70 243.98 C 770.99 248.83 780.57 253.14 789.71 258.29 C 821.96 275.92 851.94 298.02 877.15 324.84 C 886.18 333.69 893.67 343.93 902.07 353.31 C 905.33 348.44 906.99 342.74 909.40 337.44 C 915.56 323.24 920.26 308.47 924.69 293.65 C 937.12 249.68 939.46 202.36 928.02 157.92 C 927.80 156.71 926.68 156.17 925.57 156.50 M 408.36 454.45 C 387.10 457.31 367.85 470.18 355.37 487.40 C 346.15 500.23 339.89 515.29 337.92 531.01 C 335.58 550.29 338.21 570.46 347.18 587.84 C 348.91 590.96 350.23 594.54 353.01 596.91 C 359.21 598.91 365.77 599.71 371.85 602.16 C 387.59 607.43 400.34 618.58 412.03 629.97 C 414.22 631.84 415.98 634.78 419.00 635.31 C 430.09 635.81 441.03 632.63 450.96 627.87 C 478.59 614.28 496.57 585.02 499.61 554.78 C 501.63 533.25 496.79 511.03 485.41 492.59 C 477.89 480.77 467.71 470.51 455.58 463.43 C 441.54 455.02 424.47 452.31 408.36 454.45 M 708.36 454.36 C 687.20 456.27 668.37 469.10 655.61 485.61 C 642.88 502.19 636.30 523.16 636.17 543.99 C 635.72 559.68 640.08 575.21 646.75 589.30 C 655.89 606.02 669.63 620.95 687.34 628.65 C 697.69 633.61 709.38 636.25 720.85 635.14 C 724.58 632.50 727.10 628.54 730.61 625.64 C 744.01 614.11 759.46 604.81 776.30 599.29 C 779.66 597.92 783.97 597.39 785.84 593.86 C 789.14 588.17 791.66 582.05 793.91 575.89 C 805.55 542.13 797.32 501.60 771.50 476.49 C 755.40 459.93 731.33 451.10 708.36 454.36 M 553.37 589.45 C 549.51 590.25 545.41 590.88 542.05 593.07 C 540.16 594.78 542.06 597.22 543.23 598.74 C 547.82 604.22 553.47 608.86 559.80 612.20 C 562.77 613.69 566.36 615.16 569.60 613.55 C 575.52 610.91 580.25 606.30 584.94 601.95 C 586.97 599.87 589.36 597.84 590.26 594.99 C 590.31 593.26 588.26 592.63 587.04 591.93 C 576.45 587.45 564.53 588.14 553.37 589.45 M 357.42 620.44 C 351.00 624.15 345.36 629.08 339.09 633.06 C 336.66 634.98 332.54 636.85 333.38 640.63 C 333.66 643.67 337.38 645.65 340.04 644.09 C 344.46 641.66 348.16 638.14 352.42 635.44 C 356.06 632.78 360.32 630.75 363.20 627.20 C 365.53 623.57 361.51 618.33 357.42 620.44 M 782.36 621.37 C 780.53 621.67 778.67 623.04 778.66 625.05 C 778.53 627.78 780.42 630.05 781.66 632.34 C 784.60 636.82 786.74 641.79 789.82 646.18 C 792.25 649.68 798.95 647.49 798.36 643.01 C 796.81 637.16 792.49 632.58 789.71 627.30 C 787.99 624.67 786.28 620.38 782.36 621.37 M 754.39 629.39 C 752.35 630.81 751.67 633.85 752.98 635.99 C 755.19 639.96 758.43 643.23 761.12 646.88 C 763.65 650.03 765.72 653.56 768.53 656.49 C 770.86 659.03 775.96 657.45 776.31 653.95 C 776.71 650.65 774.10 648.13 772.34 645.67 C 768.37 640.93 765.01 635.71 761.11 630.93 C 759.64 628.74 756.67 628.59 754.39 629.39 M 374.39 630.36 C 369.21 633.27 365.90 638.58 361.36 642.35 C 359.16 644.85 355.06 647.07 355.81 650.93 C 356.22 654.40 361.05 655.93 363.51 653.54 C 368.08 649.79 371.86 645.20 376.20 641.20 C 378.03 639.20 380.86 637.15 380.29 634.07 C 380.01 631.27 377.02 629.40 374.39 630.36 M 554.12 647.10 C 541.87 655.54 526.80 659.44 512.01 659.37 C 505.23 659.10 497.96 658.60 492.08 654.91 C 488.82 652.88 486.83 647.27 482.23 648.91 C 478.40 650.46 479.45 655.76 481.77 658.23 C 487.10 664.18 495.21 666.68 502.82 668.17 C 524.36 670.83 547.09 664.92 564.10 651.30 C 565.53 651.99 566.79 652.98 568.05 653.95 C 580.65 664.16 597.11 668.16 613.00 669.19 C 622.43 669.13 632.55 668.89 640.84 663.78 C 644.97 661.22 648.43 656.18 647.00 651.17 C 646.31 648.40 642.44 647.44 640.42 649.33 C 638.16 651.78 637.16 655.48 633.96 656.97 C 629.04 659.41 623.43 659.67 618.04 659.70 C 602.21 660.32 585.45 656.26 573.26 645.74 C 570.19 643.48 568.56 638.19 564.08 638.74 C 560.10 640.58 557.78 644.73 554.12 647.10 Z" />
  </svg>
);

const ServerList = () => {
  const { currentServerId, setCurrentServer } = useUIStore();
  const { openModal } = useModalStore();
  const unreadChannelIds = useUnreadStore(state => state.unreadChannelIds);
  const { servers, channelQueries: serverQueries } = useServersWithChannels();

  const hasUnread = (serverId: string, index: number) => {
    const channels = serverQueries[index].data;
    if (!channels) return false;
    return channels.some(c => unreadChannelIds.has(c._id));
  };

  return (
    <div className="w-[72px] bg-mew-darkest flex flex-col items-center py-3 space-y-2 overflow-y-auto no-scrollbar flex-shrink-0 z-20">
      <div className="relative flex items-center justify-center w-full">
        {currentServerId === null && (
           <div className="absolute left-0 top-1/2 -translate-y-1/2 w-[4px] h-[40px] bg-white rounded-r-full" />
        )}
        <button
            onClick={() => setCurrentServer(null)}
            className={clsx(
            "relative group flex items-center justify-center w-12 h-12 rounded-[24px] hover:rounded-[16px] transition-all duration-200",
            currentServerId === null ? "bg-mew-accent rounded-[16px] text-white" : "bg-mew-dark text-mew-text hover:bg-mew-accent hover:text-white"
            )}
        >
            <MewLogo width={28} height={28} />
        </button>
      </div>

      <div className="w-8 h-[2px] bg-mew-darker rounded-full my-2" />

      {servers?.map((server, index) => {
        const isUnread = hasUnread(server._id, index);
        const isActive = currentServerId === server._id;

        return (
            <div key={server._id} className="relative flex items-center justify-center w-full">
                {isActive && (
                    <div className="absolute left-0 top-1/2 -translate-y-1/2 w-[4px] h-[40px] bg-white rounded-r-full" />
                )}
                
                <div className="relative">
                    <button
                        onClick={() => setCurrentServer(server._id)}
                        className={clsx(
                        "group relative flex items-center justify-center w-12 h-12 rounded-[24px] hover:rounded-[16px] transition-all duration-200 overflow-hidden",
                        isActive ? "rounded-[16px] ring-2 ring-offset-2 ring-offset-mew-darkest ring-mew-accent" : "bg-mew-dark hover:bg-mew-accent"
                        )}
                    >
                        {server.avatarUrl ? (
                        <img src={server.avatarUrl} alt={server.name} className="w-full h-full object-cover" />
                        ) : (
                        <span className="text-sm font-medium text-mew-text group-hover:text-white transition-colors">
                            {server.name.substring(0, 1).toUpperCase()}
                        </span>
                        )}
                    </button>
                    {isUnread && !isActive && (
                         <div className="absolute -bottom-0.5 -right-0.5 w-4 h-4 bg-red-500 rounded-full border-[3px] border-mew-darkest pointer-events-none flex items-center justify-center">
                         </div>
                    )}
                </div>
            </div>
        )
      })}

      <button 
        onClick={() => openModal('createServer')}
        className="group flex items-center justify-center w-12 h-12 rounded-[24px] bg-mew-dark text-green-500 hover:bg-green-600 hover:text-white transition-all duration-200 hover:rounded-[16px]"
      >
        <Icon icon="mdi:plus" width="24" height="24" className="transition-transform group-hover:rotate-90" />
      </button>

      <button 
        onClick={() => openModal('joinServer')}
        className="group flex items-center justify-center w-12 h-12 rounded-[24px] bg-mew-dark text-mew-text hover:bg-[#35373C] hover:text-white transition-all duration-200 hover:rounded-[16px]"
        title="Join a Server"
      >
        <Icon icon="mdi:compass-outline" width="24" height="24" />
      </button>
    </div>
  );
};

export default ServerList;
