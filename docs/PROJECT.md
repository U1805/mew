项目名 Mew

技术栈：
即时通讯平台我打算使用 Express 开发
前端 核心框架: React
状态管理：Zustand
数据请求：TanStack Query
UI 样式: Tailwind CSS
图标库: Iconify
富文本编辑器：TipTap
开发语言: TypeScript
后端 运行环境: Express
实时通信: Socket.io
数据校验：Zod
持久化数据库: MongoDB
文件对象存储: Garage
容器化: Docker
编排工具: Docker Compose
CI/CD: GitHub Actions
bot 部分，消息推送相关的 bot 通过 golang 开发和轮询，聊天机器人通过 python 开发（具体实现待定）

#### **一、 项目核心愿景 (The Vision)**

我们旨在构建一个高度私有化、可扩展的个人数字中枢。它并非多个独立应用的聚合，而是将**信息流、工作流、情感交互流**统一到一个以**即时通讯（IM）**为核心交互界面的平台中。

这个平台的核心隐喻是 **“私有化的 Discord”**：
*   **Discord 的服务器/频道结构**被用作灵活的数据组织容器。
*   **聊天界面**成为所有交互的统一入口。
*   **Bot 生态**则扮演着后台的“微服务”，负责处理所有具体的业务逻辑。

#### **二、 核心架构：IM 平台 + Bot 生态 (The Architecture)**

这是一个典型的**“总线-服务”**解耦架构，具备极高的灵活性和可扩展性。

1.  **即时通讯平台 (The Bus/Hub):**
    *   **角色**：作为系统的“神经中枢”和“前端展示层”。
    *   **职责**：它**只负责**消息的实时、可靠传输、存储和呈现。它不关心消息的内容是 RSS 新闻还是 AI 的思考，只保证消息能被正确地收发和查询。
    *   **优点**：平台本身保持功能纯粹、稳定，所有复杂业务逻辑的变更都不会影响核心平台的运行。

2.  **Bot 生态 (The Services):**
    *   **角色**：作为系统的“大脑”和“四肢”，是所有具体功能的实现者。
    *   **职责**：每个 Bot 都是一个独立的、可单独开发和运行的服务。例如：RSS 爬虫 Bot、AI 聊天 Bot、写作助手 Bot。
    *   **优点**：功能高度模块化。未来增加新功能（如账单监控、代码部署通知），只需开发一个新的 Bot，而无需改动平台代码。

#### **三、 即时通讯平台：功能规格 (IM Platform Specifications)**

这是整个系统的基石，需要实现以下功能：

*   **核心结构**：
    *   **服务器 (Server)**：最高层级的隔离单位，对应你的一个大用途，如“信息汇总”、“写作项目A”。
    *   **分组 (Category)**：服务器内频道的逻辑分组，用于整理。
    *   **频道 (Channel)**：消息实际发生的场所。
    *   **私聊 (DM)**：用户与用户（包括 Bot 用户）之间的一对一聊天。

*   **消息功能**：
    *   **内容类型**：支持发送文本（Markdown）、图片、文件、表情包。
    *   **交互功能**：消息引用/回复、@提及用户、消息撤回、消息编辑、Reaction（表情回应）。
    *   **体验功能**：消息历史加载、历史消息全文检索。

*   **通信协议**：
    *   核心采用 **WebSocket** 实现消息的实时双向通信。
    *   辅以 **HTTP RESTful API** 用于执行非实时性操作（如修改个人信息、创建频道、发送 Webhook 消息）。

*   **用户与鉴权**：
    *   **用户系统**：简化为单用户系统，用户信息直接在配置文件中定义。数据库中用户表包含 `is_bot` 字段以区分真人与机器人。
    *   **鉴权**：所有 API 请求通过 `Authorization` 头中的 Bearer Token 进行身份验证。

#### **四、 关键技术设计 (Key Technical Designs)**

1.  **消息协议：插件化渲染 (Pluggable Rendering Protocol)**
    为了支持 RSS 卡片等丰富的消息样式，我们设计了一套灵活的消息 Schema。
    ```json
    {
      "type": "app/x-rss-card", // MIME-Type 风格，决定前端渲染方式
      "content": "[文章] OpenAI 发布新模型...", // 不支持插件时的降级纯文本
      "payload": { // 供前端渲染插件使用的结构化数据
        "title": "OpenAI 发布新模型",
        "summary": "这是一个重要的里程碑...",
        "url": "https://example.com/news/123",
        "thumbnail_url": "https://.../image.png"
      }
    }
    ```
    *   **前端实现**：前端将有一个消息渲染引擎，根据 `type` 字段动态加载并调用对应的渲染组件（如RSS 卡片插件），实现UI的可扩展性。

2.  **Bot 连接模式 (Bot Connection Modes)**
    平台提供两种模式供不同类型的 Bot 接入：
    
    *   **Webhook (单向推送)**
        *   **机制**：为某个频道生成一个唯一的 URL，可选绑定到一个指定的 Bot 身份（绑定后该 Bot 获得该频道的权限）。
        *   **用途**：适用于只需推送消息的场景，如 RSS 爬虫、Github 通知等。外部服务只需向此 URL 发送一个 POST 请求即可。
        *   **优点**：简单、无状态、Serverless 友好。
    
    *   **Gateway / WebSocket (双向实时)**
        *   **机制**：Bot 作为一个客户端，通过 WebSocket 长连接接入平台，实时接收 `MESSAGE_CREATE`、`MESSAGE_REACTION_ADD` 等事件。
        *   **用途**：适用于需要实时交互的 Bot，如 AI 聊天伴侣、写作助手。
        *   **优点**：低延迟、事件驱动、交互性强。

    Bot 可访问的频道/DM：
    - Bot 由某个用户创建，默认拥有与该用户的 DM 权限
    - 创建 Bot 的用户可以频道设置中，通过 webhook 绑定赋予 Bot 访问频道的权限（即使 Gateway 接入频道也需要 webhook 绑定获得频道权限）
    - （普通用户在加入服务器后默认拥有该服务器中所有频道的权限）

#### **五、 核心需求实现方案 (Use Case Implementation)**

1.  **私人消息汇总平台**
    *   **流程**：外部爬虫脚本（独立运行）获取到新内容 -> 调用绑定了“信息源 Bot”身份的 Webhook URL -> 平台收到请求，将格式化后的消息（`type: "app/x-rss-card"`）发送到指定频道 -> 前端通过 RSS 插件渲染成卡片。
    *   **组织**：创建一个名为“信息流”的 `Server`，按来源（如“科技”、“社交”）创建 `Category`，每个具体订阅源（如“Hacker News”、“Bilibili-UP主A”）对应一个 `Channel`。

2.  **私人聊天机器人**
    *   **交互流程**：用户在 DM 中发送消息 -> 平台通过 WebSocket Gateway 推送 `MESSAGE_CREATE` 事件给 AI Bot -> Bot 接收事件，调用大模型（LLM）API -> Bot 通过 API 回复消息。
    *   **记忆模块实现**：
        *   **后端存储**：Bot 拥有一个独立的**向量数据库**用于长期记忆的存储和检索。
        *   **可视化日志**：当 Bot 形成一条新记忆时（如“用户喜欢科幻电影”），它会将这条记忆的文本摘要发送到一个私有的“记忆日志” `Channel` 中。这为用户提供了一个可追溯、可手动干预（通过删除/编辑消息来管理记忆）的界面。

3.  **写作助手 (未来展望)**
    *   **组织**：每个写作项目是一个 `Server`。`Channel` 可以用来存放草稿、资料、大纲等。
    *   **交互**：用户与写作 Bot 在 DM 或特定频道中交谈。Bot 可以利用平台的搜索 API 快速查找历史资料，并利用消息引用功能将过去的伏笔“引用”到当前的对话中，实现上下文的无缝衔接。
