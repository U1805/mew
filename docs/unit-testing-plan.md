# 前端单元测试计划

本文档旨在规划和定义 `frontend` 应用的单元测试策略，以确保代码质量、功能正确性并防止未来出现回归。

## 1. 测试目标

- **正确性验证**：确保组件、Hooks 和服务在各种输入和条件下都能按预期工作。
- **回归 방지**：在代码库中建立一个安全网，以便在修改现有代码时能够快速发现意外的副作用。
- **文档化**：测试本身将作为代码行为的一种实时文档。
- **促进重构**：良好的测试覆盖率为未来的代码重构和改进提供了信心。

## 2. 技术栈与工具

我们将使用以下工具来构建和运行测试：

- **测试运行器 (Test Runner)**: `Vitest` - 一个与 Vite 集成的现代化测试框架。
- **DOM 环境**: `happy-dom` - 用于在 Node.js 中模拟浏览器 DOM 环境。
- **测试库**: `@testing-library/react` - 用于以用户为中心的方式查询和与组件交互。
- **断言库**: `Vitest` 内置的 `expect` (与 Jest/Chai 兼容)。
- **API 模拟**: `msw` (Mock Service Worker) - 在网络层面拦截和模拟 API 请求，提供高保真度的测试。
- **模块/函数模拟**: `vitest.fn()` 和 `vitest.mock()` - 用于创建和追踪函数调用，或替换模块的实现。

## 3. 测试范围

我们的测试将覆盖以下几个关键领域：

- **组件 (Components)**:
  - **UI/展示型组件**: 测试它们是否能根据传入的 `props` 正确渲染，并响应用户交互（如点击、输入）。
  - **容器/逻辑型组件**: 测试组件内部的状态管理、与 Hooks 的集成以及对 API 调用的处理（加载、成功、失败状态）。
- **自定义 Hooks (Custom Hooks)**: 在隔离的环境中测试 Hooks 的内部逻辑和返回值。
- **状态管理 (State Management - Zustand)**: 针对 `store` 编写测试，以验证 actions 是否能正确更新状态。
- **工具函数 (Utilities/Services)**: 对项目中的纯函数或服务进行单元测试。

## 4. 测试策略与约定

- **文件位置和命名**: 测试文件将与被测试的源文件放在同一目录下，并使用 `.test.tsx` (或 `.test.ts`) 的后缀。例如：`Button.tsx` 的测试文件是 `Button.test.tsx`。
- **测试原则**: 遵循 `@testing-library/react` 的核心理念——“测试越像软件的实际使用方式，就越能带给你信心”。我们将避免测试组件的内部实现细节，而是关注其对用户的可见行为。
- **模拟策略**:
  - **API**: 使用 `msw` 在网络层面拦截所有 API 请求。这将使我们的测试更接近真实的用户场景。
  - **模块**: 对于外部依赖或难以在测试环境中实例化的模块（如 `socket.io-client`），将使用 `vitest.mock()` 进行模拟。

## 5. 实施步骤

我将按照以下步骤进行测试的编写：

1.  **设置测试环境**:
    -   在 `vite.config.ts` 中配置 `vitest`，指定测试环境为 `happy-dom`，并设置全局变量和启动文件。
    -   创建一个测试启动文件 (例如 `src/test/setup.ts`)，用于导入 `@testing-library/jest-dom` 的扩展断言，并配置 `msw` 的启动与关闭。

2.  **编写第一个组件测试**:
    -   选择一个简单的、无状态的 UI 组件作为起点，例如 `ChannelItem` 或 `UserStatusFooter` 中的一个按钮。
    -   编写测试，验证该组件是否能根据 props 正确渲染，并正确处理点击事件。

3.  **编写涉及状态管理的组件测试**:
    -   选取一个与 `Zustand` store 交互的组件，例如 `UserSettings`。
    -   测试组件是否能正确地从 store 中读取状态并展示，以及是否能通过 actions 正确地更新状态。

4.  **编写涉及 API 调用的组件测试**:
    -   为 `authApi`、`serverApi` 等设置 `msw` 处理器 (handlers)。
    -   测试一个使用 `useQuery` 的组件，例如 `ChannelList`。
    -   验证其在加载中 (loading)、成功 (success) 和失败 (error) 状态下的渲染行为。

5.  **编写自定义 Hooks 的测试** (如果存在):
    -   使用 `@testing-library/react` 的 `renderHook` 方法来独立测试任何自定义 Hooks 的逻辑。

## 6. 审查与合并

每完成一个主要步骤，我都会运行所有测试以确保没有引入回归。在您审查并批准每个阶段的工作后，我们将逐步构建起整个应用的测试覆盖。
